---
title: "Covid-19 USA Time series"
output: html_notebook
---

# Introduction

This is an analysis of USA Covid-19 pandemic data as available from Johns Hopkins University in combination with US Census data on population. 

To hide code, toggle the 'Code' button on the top right of this page.


```{r, message=FALSE, warning=FALSE}
##################################
# packages and working directory
##################################

library(tidyverse)
library(lubridate)
library(scales)
library(httr)
library(RCurl)
library(kableExtra)
library(ggrepel)
require(maps)
require(tools)
require(gridExtra)
if(!require(viridis)) {
  install.packages("viridis", repos="http://cloud.r-project.org")
  require(viridis)
}
require(knitr)
require(mapproj)
require(gganimate)
library(gifski)
library(transformr)
library(tweenr)

options('gganimate.renderer' = gifski_renderer())
options(gganimate.dev_args = list(width = 1920, height = 1080))
print.gif_image <- function(x, ...) knitr::include_graphics(x, ...) # Bug fix in ggannimate


setwd(tempdir())

ns <- function (x, acc=1) number_format(accuracy = acc, scale = 1, suffix = "", big.mark = ",")(x)
ks <- function (x, acc=1) number_format(accuracy = acc, scale = 1/1000, suffix = "k", big.mark = ",")(x)
Ms <- function (x, acc=1) number_format(accuracy = acc, scale = 1/1000000, suffix = "M", big.mark = ",")(x)

theme_map <- function(...) {
	theme_minimal() +
  theme(
    text = element_text(color = "#22211d"),
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    # panel.grid.minor = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.major = element_line(color = "#ebebe5", size = 0.2),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#f5f5f2", color = NA), 
    panel.background = element_rect(fill = "#f5f5f2", color = NA), 
    legend.background = element_rect(fill = "#f5f5f2", color = NA),
    panel.border = element_blank(),
    ...
  )
}

toRadians <- function(x) pi*x/180

# distance in meter on the earth between 2 locations with coordinates  (lat1,lon1) and (lat2,lon2)
Distance <- function(lat1,lon1,lat2,lon2){
  phi1 = toRadians(lat1) 
  phi2 = toRadians(lat2)
  dlambda = toRadians(lon2-lon1) 
  R = 6371e3; #gives d in metres
  acos( sin(phi1)* sin(phi2) + cos(phi1)*cos(phi2) * cos(dlambda) ) * R;
}

```



# Data Loading

The data for this analysis is from

- Johns Hopkins University Covid-19 data https://github.com/CSSEGISandData/COVID-19

- USPS State abriviations and fips codes

- USA Census data https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/totals/co-est2019-alldata.csv


```{r, message=FALSE}
####################################################################
# Johns Hopkins University Covid19 data on github: USA time series data
####################################################################
datapath <- "CSSEGISandData/COVID-19"

# get a file list
req <- GET(paste0("https://api.github.com/repos/", datapath,"/git/trees/master?recursive=1"))
stop_for_status(req)

content(req)$tree %>%
  lapply("[", "path") %>%
	unlist(use.names = F) %>%
  grep("csse_covid_19_data/csse_covid_19_time_series/", ., value = TRUE, fixed = TRUE) %>%
  grep(".csv", ., value = TRUE, fixed = TRUE) %>%
  grep("US", ., value = TRUE, fixed = TRUE) %>%
	lapply(function(x) { #read all the csv files
		read_csv(file.path("https://raw.githubusercontent.com", datapath, 'master', x)) %>%
		mutate(Metric=str_to_title(str_sub(x,66,-8))) %>%
		pivot_longer(cols=matches("[0-9]+/[0-9]+/[0-9]+"), names_to='Date', values_to='n') 
	})	%>% 
	do.call(bind_rows, .) %>%
	mutate_each(funs(mdy), Date) %>% 
	select(-Combined_Key) %>%
	mutate(FIPS=str_pad(FIPS,5,side="left",pad="0")) -> df
	#mutate_each(funs(as.factor), Metric,UID,iso2,iso3,code3,FIPS, Admin2, Province_State, Country_Region) -> df

```

Note
- there are no FIPS codes for some census designated places
 mitigation : provide population hard-coded from wikipedia?


```{r, message=FALSE}
####################################################################
# USPS State abriviations and fips codes
####################################################################

read_csv("https://gist.githubusercontent.com/dantonnoriega/bf1acd2290e15b91e6710b6fd3be0a53/raw/11d15233327c8080c9646c7e1f23052659db251d/us-state-ansi-fips.csv") -> StateAbreviations

####################################################################
# US Census county population data
####################################################################

read_csv("https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/totals/co-est2019-alldata.csv") %>% 
	select("SUMLEV","REGION","DIVISION","STATE","COUNTY", "STNAME","CTYNAME", "POPESTIMATE2019") %>%
	mutate(SUMLEV = fct_recode(as.factor(SUMLEV), State="040", County="050")) %>%
	mutate(REGION = fct_recode(as.factor(REGION), Northeast="1", Midwest="2", South="3", West="4")) %>% 
	mutate(DIVISION = fct_recode(as.factor(DIVISION), `New England`="1", `Middle Atlantic`="2", `East North Central`="3", `West North Central`="4",`South Atlantic`="5", `East South Central`="6", `West South Central`="7", `Mountain`="8", `Pacific`="9")) %>%
	mutate(CTYNAME = if_else(STATE == "35" & COUNTY == "013","Dona Ana County", CTYNAME)) %>% #bug fix with non utf character
	mutate_at(vars(STATE,COUNTY), as.factor) -> USCensus
```


# Data wrangeling

merge data from 4 different sources -> FIPS code is key to join
- JHU covid19 data
- US census data
- USPS state abreviation data
- ggplot US maps geo data

- Thought: This would be better done with a make data pipeline (see drake package)
how to do this with make? in R: lear drake https://www.rdocumentation.org/packages/drake/versions/7.5.2


```{r, warning=FALSE}
###############################################################################################
# US Census data: split US census data in states and counties, add USPS abreviations to states
###############################################################################################
USCensus %>% 
	filter(SUMLEV == "State") %>%
	select(-SUMLEV) %>%
  left_join(select(StateAbreviations,st, USPS=stusps), by=c("STATE"="st")) %>%
	select(-COUNTY,-CTYNAME) -> USStates.Census

USCensus %>% 
	filter(SUMLEV == "County") %>%
	select(-SUMLEV) %>%
	mutate(FIPS = str_c(as.character(STATE), as.character(COUNTY)) ) %>% # combines state/county FIPS code
	mutate(CTYNAME=replace(CTYNAME, FIPS == 11001, "Washington")) %>% # COUNTY name for DC is Washington
	left_join(select(StateAbreviations,st, USPS=stusps), by=c("STATE"="st")) -> USCounties.Census
```


```{r, message=FALSE}
###############################################################################################
# geo map data for USA states and counties
# fix some names, add STATE and FIPS code
# Creates:
# - map.state: geo State maps with STATE code for joining purpose
# - map.county: geo County maps with FIPS code for joining purpose
# Note: some census units are not on map
###############################################################################################
# see https://en.wikipedia.org/wiki/Centroid polygon

Area <- function(long,lat) sum(long*lead(lat,default=first(lat)) - lead(long,default=first(long))*lat) / 2
CentroidLong <- function(long,lat) sum((long + lead(long, default=first(long))) * (long*lead(lat,default=first(lat)) - lead(long,default=first(long))*lat)) / Area(long,lat) / 6
CentroidLat <- function(long,lat) sum((lat + lead(lat, default=first(lat))) * (long*lead(lat,default=first(lat)) - lead(long,default=first(long))*lat)) / Area(long,lat) / 6

state_path <- file.path("~","DataScience","Covid19","data","MapLinkState.csv")
if (!file.exists(state_path)) {
  map_data("state") %>% # note Hawaii and Alaska are not included
	  group_by(region) %>% 
	  summarise(Long=CentroidLong(long,lat), Lat=CentroidLat(long, lat)) %>% # use centroid 
    left_join(transmute(USStates.Census, region=tolower(STNAME), STATE),by="region") %>%
  	write_csv(state_path)
}
read_csv(state_path) -> Link.map.state

map_data("state") %>% left_join(select(Link.map.state, region, STATE), by="region") -> map.state

# create a linktable of geometric map counties with FIPS codes and Census data, persistent storage to avoid repeated calcalation
county_path <- file.path("~","DataScience","Covid19","data","MapLinkCounty.csv")

map_data("county") %>% # note Hawaii and Alaska counties are not included
	filter(group != 1621) %>% # yellowstone national is duplicate with park county
	mutate(subregion=replace(subregion, group == 2386, "ogala lakota")) %>% # shannon county changed name to ogala lakota county 
	left_join(select(Link.map.state, region, STATE), by="region") -> map.county

if (!file.exists(county_path)) {
  require(reclin)

  pair_blocking(transmute(USCounties.Census, FIPS, STATE, region=tolower(STNAME), subregion=tolower(CTYNAME)), 
	  						group_by(map.county, STATE, region, subregion) %>% summarise(Long=CentroidLong(long,lat), Lat=CentroidLat(long, lat)), 
		  					blocking_var = "STATE", large = FALSE) %>% 
    compare_pairs(by = "subregion", default_comparator = jaro_winkler(0.8), overwrite = TRUE) %>% 
	  score_problink(., model = problink_em(.), var = "weight") %>% 
    select_n_to_m("weight", var = "ntom", threshold = 0) %>% 
    link() %>% 
	  filter(!is.na(subregion.y)) %>% 
  	select(FIPS,region=region.y, subregion=subregion.y, Long, Lat) %>%
	  write_csv(county_path)
}

read_csv(county_path)  -> Link.map.county

map.county %>% 
	  left_join(Link.map.county, by=c("region","subregion")) ->  map.county 
```



```{r}
###############################################################################################
# Merge US census data and geo map data for state and counties: 
# this is all state county demographic data not depending on covid data
###############################################################################################
# summary state and county data, with location and populaton metrics with STATE na d FIPS code as key

USStates.Census %>% left_join(select(Link.map.state, -region), by="STATE") %>% ungroup -> USStates

USCounties.Census %>% left_join(select(Link.map.county,-region,-subregion), by="FIPS") %>% ungroup -> USCounties
```



```{r}
###############################################################################################
# Johns Hopkins University Covid19 data: derive calculated data
###############################################################################################

# add STATE variable
df %>% filter(!is.na(Admin2)) %>%
	group_by(Province_State) %>% summarise %>% 
	left_join(select(USStates, STNAME, STATE), by=c("Province_State"="STNAME")) -> Link

# Derive Covid data: deltas, ranks, per cobservation and aggregated for county, state
df %>% left_join(Link, by="Province_State") %>%
	select(UID, FIPS, STATE, Province_State, County=Admin2, Date, Metric, n) %>%
	pivot_wider(names_from=c("Metric"), values_from="n") %>% 
	mutate(CFR = Deaths / Confirmed) %>%  # lots of NaN due to 0 Deaths and 0 Cases
	pivot_longer(cols=c('Confirmed', 'Deaths', 'CFR'), names_to='Metric', values_to='n') -> df1 

df1 %>% group_by(UID, Metric ) %>% 
	arrange(Date) %>%
	mutate(delta  = n - lag(n, 1, default=0), delta7  = n - lag(n, 7, default=0), delta14 = n - lag(n, 14, default=0), 
				 deltasquare14 =  delta14 - lag(delta14, 14, default=0), rel14 =  delta14 / lag(delta14, 14, default=1)-1) %>% # increase new cases in 2 weeks, absolute and relative
	mutate(rank = rank(-n, ties.method="min")) %>% # add more ranks?
	pivot_longer(cols=c('n','delta','delta7', 'delta14', 'deltasquare14','rel14','rank'), names_to='Metric2', values_to='val') %>%
  ungroup() -> USCounties.JHU.all

df1 %>% group_by(Province_State, STATE, Metric, Date ) %>% 
	summarise (n=sum(n)) %>%
	arrange(Date) %>%
	mutate(delta  = n - lag(n, 1, default=0), delta7  = n - lag(n, 7, default=0), delta14 = n - lag(n, 14, default=0), 
				 deltasquare14 =  delta14 - lag(delta14, 14, default=0), rel14 =  delta14 / lag(delta14, 14, default=1)-1) %>% # increase new cases in 2 weeks, absolute and relative
	mutate(rank = rank(-n, ties.method="min")) %>% # add more ranks?
	pivot_longer(cols=c('n','delta','delta7', 'delta14', 'deltasquare14','rel14','rank'), names_to='Metric2', values_to='val') %>%
  ungroup() -> USStates.JHU.all
```


```{r}
####################################################################
# Derive Summary JHU Covid data as of last Date
####################################################################
USStates.JHU.all %>%  
	group_by(Province_State, STATE, Metric,  Metric2) %>% 
	arrange(Date) %>%
	summarise_all(last) %>% 
	ungroup() ->  USStates.JHU

USCounties.JHU.all %>%
	group_by(UID, FIPS, Metric, Metric2) %>% 
	arrange(Date) %>%
	summarise_all(last) %>% 
	ungroup() ->  USCounties.JHU

# to do add: max n, max delta, smoothed n, max smoothed n	
```


```{r}
####################################################################
# Tidy data sets: all dates and summaries for States and Counties
####################################################################

USStates.JHU.all %>% left_join(USStates, by="STATE") %>% ungroup ->  USStates.Covid19.all

USCounties.JHU.all 	%>% left_join(USCounties, by="FIPS") %>% ungroup ->  USCounties.Covid19.all

USStates.JHU 	%>% left_join(USStates, by="STATE") %>% ungroup ->  USStates.Covid19

USCounties.JHU 	%>% left_join(USCounties, by="FIPS") %>% ungroup->  USCounties.Covid19
```


# Graphical Exploration

## Per State

### Confirmed Cases US State Map
todo add USA total
```{r,fig.width=13}
####################################################################
# Confirmed Cases US Map
####################################################################
USStates.Covid19 %>%
	filter(Metric == "Confirmed", Metric2 == 'n') %>% 
	select(STATE, USPS, val, Lat, Long) %>% 
	{
	left_join(map.state, ., by="STATE") %>% 	
  ggplot(aes(x = long, y = lat)) +
  geom_polygon(aes(group = group, fill=val), colour = "white") +
	geom_label_repel(data=., aes(label=paste(USPS,":", ks(val,acc=0.1)), x = Long, y = Lat), size=3, colour = "black", hjust=.5) +			
  geom_point(data=data.frame(lat=42.8126, long=-70.8773), size=4, shape=1, color='red') +
	theme_map() + 
	coord_map() +
	geom_label(data=data.frame(lat=48, long=-80), label=paste("US Total = ", Ms(sum(.$val),acc=0.01)), color="black", size=5, fontface="bold") +	
	labs(x = NULL, y = NULL, title = "USA Covid-19 Confirmed Cases per US State", 
         subtitle = paste('Date :', max(USStates.Covid19.all$Date)), 
         caption = "Geometries: ggplot2 maps; Covid-19 Data: JHU CSSE") +
	theme(legend.position = "right") +	
	scale_fill_viridis( option = "inferno", direction = +1, name = "Cases", limits= c(0,NA), trans= "log1p", breaks=10^seq(0,5), labels = label_number(accuracy = 1,big.mark = ','),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))
	}
```

### US State Map: New Cases yesterday

todo: fix north dakota: delta seems to be -35 

```{r,fig.width=13}
####################################################################
# US Map: New cases in the last day  
####################################################################
USStates.Covid19 %>%
	filter(Metric == "Confirmed", Metric2 == 'delta') %>% 
	select(STATE, USPS, val,Long, Lat) %>%
	{
	left_join(map.state, ., by="STATE") %>% 
  ggplot(aes(x = long, y = lat)) +
  geom_polygon(aes(group = group, fill=val), colour = "white") +
	geom_label_repel(data=., aes(label=paste(USPS,":", ns(val)), x = Long, y = Lat), size=3, colour = "black") +	
  geom_point(data=data.frame(lat=42.8126, long=-70.8773), size=4, shape=1, color='red') +
	theme_map() + 
	coord_map() +
	geom_label(data=data.frame(lat=48, long=-80), label=paste("US Total = ", ks(sum(.$val),acc=0.1)), color="black", size=5, fontface="bold") +	
	labs(x = NULL, y = NULL, title = "USA Covid-19 New Cases on Date", 
         subtitle = paste('Date :', max(USStates.Covid19.all$Date)), 
         caption = "Geometries: ggplot2 maps; Covid-19 Data: JHU CSSE") +
	theme(legend.position = "right") +	
	scale_fill_viridis( option = "inferno", direction = +1, name = "Cases", limits= c(0,NA), trans= "log1p", breaks=10^seq(0,5), labels = label_number(accuracy = 1,big.mark = ','),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))
	}
```

###  US State Map: New Cases in the last 2 weeks


```{r,fig.width=13}
####################################################################
# New Cases in the last 2 weeks US State Map
####################################################################
USStates.Covid19 %>%
	filter(Metric == "Confirmed", Metric2 == 'delta14') %>% 
	select(STATE, USPS, val, Lat, Long) %>%
	{
	left_join(map.state, ., by="STATE") %>% 
  ggplot(aes(x = long, y = lat)) +
  geom_polygon(aes(group = group, fill=val), colour = "white") +
	geom_label_repel(data=., aes(label=paste(USPS,":", ns(val)), x = Long, y = Lat), size=3, colour = "black") +	
	geom_point(data=data.frame(lat=42.8126, long=-70.8773), size=4, shape=1, color='red') +
	theme_map() + 
	coord_map() +
	geom_label(data=data.frame(lat=48, long=-80), label=paste("US Total = ", ks(sum(.$val),acc=0.1)), color="black", size=5, fontface="bold") +			
	labs(x = NULL, y = NULL, title = "USA Covid-19 New Cases in last 2 weeks", 
         subtitle = paste('Date :', max(USStates.Covid19.all$Date)), 
         caption = "Geometries: ggplot2 maps; Covid-19 Data: JHU CSSE") +
	theme(legend.position = "right") +	
	scale_fill_viridis( option = "inferno", direction = +1, name = "New Cases", limits= c(0,NA), trans= "log1p", breaks=10^seq(0,5), labels = label_number(accuracy = 1,big.mark = ','),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))
}
```



###  US State Map: Increase in New Cases in the last 2 weeks

need different color scale: green is negative increase, red is positive increase, black is neutral

TO DO: fix rel14

```{r,fig.width=13}
####################################################################
#  US State Map: Increase in New Cases in the last 2 weeks
####################################################################

USStates.Covid19.all %>% 
	filter(Metric == "Confirmed", Metric2 == 'delta14') %>%
	group_by(Date) %>% 
	summarise(val=sum(val)) %>%
  mutate(rel14 = last(val / lag(val, 14)-1)) %>%
	summarise(val=last(rel14)) %>% pull(val) -> US

USStates.Covid19 %>%
	filter(Metric == "Confirmed", Metric2 == 'rel14') %>%
	select(STATE, USPS, val, Long, Lat) %>%
	{
	left_join(map.state, ., by="STATE") %>% 
  ggplot(aes(x = long, y = lat)) +
  geom_polygon(aes(group = group, fill=val), colour = "white") +
	geom_label_repel(data=., aes(label=paste(USPS,":", percent(val,acc=1)), x = Long, y = Lat), size=3, colour = "black") +	
  geom_point(data=data.frame(lat=42.8126, long=-70.8773), size=4, shape=1, color='red') +
	theme_map() + 
	coord_map() +
	geom_label(data=data.frame(lat=48, long=-80), label=paste("US Total = ", percent(US,acc=0.1)), color="black", size=5, fontface="bold") +	
	labs(title = "USA Covid-19 Increase in New Cases in last 2 weeks", 
         subtitle = paste('Date :', max(USStates.Covid19.all$Date)), 
         caption = "Geometries: ggplot2 maps; Covid-19 Data: JHU CSSE") +
	theme(legend.position = "right") +	
	scale_fill_gradient2(low="darkgreen", mid="white", high="darkred",
											name = "Increase", labels = label_percent(accuracy = 1), limits=c(-1,1), oob=squish, 
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))
	}	
```

TODO x-y scatterplot with New confirmed cases per week (or 2 weeks) and relative increase


### Heat map New Cases per 2 Weeks relative to state maximum 

```{r,fig.width=13}
####################################################################
# Graphical Exploration New Confirmed Cases per State: Heat map
####################################################################
USStates.Covid19.all %>%  
	filter(Metric == "Confirmed", Metric2 == 'delta14') %>%
	group_by(STNAME) %>% 
	filter(val == max(val)) %>% 
	select(STNAME, StartDate=Date) -> wave

USStates.Covid19.all %>%  
	filter(Metric == "Confirmed", Metric2 == 'delta14') %>% 
	group_by(STNAME) %>% 
	mutate(rval=val/max(val)) %>%
	left_join(wave, by="STNAME") %>% 
	ggplot(aes(x=Date, y=reorder(STNAME, as.integer(StartDate)))) +
  geom_tile(aes(fill=rval)) + 
	scale_x_date(limits = c(date("2020-02-29"), NA)) +
	scale_y_discrete(position = "right")	+	
	labs(title="New Confirmed Cases relative to State Peak", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="") +
	theme_bw() +
	theme(legend.position = "right") +	
	scale_fill_viridis( option = "inferno", direction = +1, name = "Cases/Max(Cases)", limits= c(0,1), trans= "identity", breaks=(0:5)/5, 
											labels = label_percent(),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))

```

Observations

- peaks start as early as first week of April and as late as current date
- there are two peak states: Nevada, Alaska, Florida, West Verginia, New Mexico, Kentucky, Tennesee, Oregon (3 peaks)

TODO per capita heatmap

### Top N States Confirmed Cases

```{r,fig.width=13}
####################################################################
# Confirmed Cases per State
####################################################################
gettop <- function(df, n=25) { group_by(df, STNAME) %>% summarise(val = max(val)) %>% top_n(n, wt=val) %>% arrange(desc(val)) %>% pull(STNAME) }


USStates.Covid19.all %>%  
	filter(Metric == "Confirmed", Metric2 == 'n') %>%
	filter(., STNAME %in% gettop(.,25), val > 9)  %>%
	  { ggplot(data=., aes(x=Date, y=val, colour=STNAME)) +
      geom_point(shape=1, size=3) + 
	    geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
      geom_label_repel(data = filter(., Date == max(Date)), aes(label = paste(USPS,ks(val,0.1),sep=",")), nudge_x=2) +
	    scale_x_date() +
	    scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                    labels = trans_format("log10", math_format(10^.x))) +
	    labs(title="Confirmed Cases for top 25 US States", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	    theme_bw() + theme(legend.position = "none")
	}
```


### Top 25 States New Cases 

```{r,fig.width=13}
####################################################################
# New Confirmed Cases per State
####################################################################

USStates.Covid19.all %>%  
	filter(Metric == "Confirmed", Metric2 == 'delta') %>%
	filter(., STNAME %in% gettop(.,25), val > 9)  %>%
  {	ggplot(data=., aes(x=Date, y=val, colour=STNAME)) +
    geom_point(shape=1, size=3) + 
	  geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
    geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(USPS,ks(val,0.1),sep=",")), nudge_x=2) +
	  scale_x_date() +
	  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                  labels = trans_format("log10", math_format(10^.x))) +
	  labs(title="New Confirmed Cases for top 25 US States", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	  theme_bw() + theme(legend.position = "none")
	}
```

###  New Cases per Day, normalized to peak, all states

```{r,fig.width=18, fig.height=13}
USStates.Covid19.all %>%  
	filter(Metric == "Confirmed", Metric2 == 'delta', val > 0) %>%
	group_by(STNAME) %>%
	mutate(rval=val/max(val)) %>%
  {	ggplot(data=., aes(x=Date, y=rval)) +
    geom_point(shape=1, size=2) + 
	  geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
    geom_label_repel(data=filter(., Date==max(Date) | val==max(val)), aes(label = val), nudge_x=2) +
	  scale_x_date(limits=c(date("2020-3-1"),NA)) +
	  #scale_y_log10(limits=c(10,NA), breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) +
	  labs(title="New Confirmed Cases per day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	  theme_bw() +
  	facet_wrap(vars(STNAME), ncol=7)
	}
```


### Heat map New Cases per Day 

```{r,fig.width=13}
####################################################################
# Graphical Exploration New Confirmed Cases per State: Heat map
####################################################################
USStates.Covid19.all %>%  
	filter(Metric == "Confirmed", Metric2 == 'n') %>%
	group_by(STNAME) %>% 
	mutate(d=abs(val-50)) %>% 
	arrange(d) %>% 
	summarise_all(first) %>% 
	select(STNAME, StartDate=Date) -> start

USStates.Covid19.all %>%  
	filter(Metric == "Confirmed", Metric2 == 'delta') %>% 
	left_join(start, by="STNAME") %>% 
	ggplot(aes(x=Date, y=reorder(STNAME, as.integer(StartDate)))) +
  geom_tile(aes(fill=val)) + 
	scale_x_date(limits = c(date("2020-02-29"), NA)) +
	scale_y_discrete(position = "right")	+	
	labs(title="US State New Confirmed Cases per Day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="") +
	theme_bw() +
	theme(legend.position = "right") +	
	scale_fill_viridis( option = "inferno", direction = +1, name = "Cases", limits= c(0,NA), trans= "pseudo_log", breaks=10^seq(0,5), 
											labels = label_number(accuracy = 1,big.mark = ','),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))

```





### Heat map: Deaths per Day

```{r,fig.width=13}
####################################################################
# Graphical Exploration New Deaths per State: Heat map
####################################################################
USStates.Covid19.all %>%  
	filter(Metric == "Deaths", Metric2 == 'n') %>%
	group_by(STNAME) %>% 
	mutate(d=abs(val-50)) %>% 
	arrange(d) %>% 
	summarise_all(first) %>% 
	select(STNAME, StartDate=Date) -> start

USStates.Covid19.all %>%  
	filter(Metric == "Deaths", Metric2 == 'delta') %>%
	left_join(start, by="STNAME") %>% 
	group_by(STNAME) %>% 
	ggplot(aes(x=Date, y=reorder(STNAME, as.integer(StartDate)))) +
  geom_tile(aes(fill=val)) + 
	#geom_tile(data=start, aes(x=StartDate), fill='red',alpha=0.5) + 	
	scale_x_date(limits = c(date("2020-02-29"),NA)) +
	scale_y_discrete(position = "right")	+	
	labs(title="US State New Deaths per Day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="") +
	theme_bw() +
	theme(legend.position = "right") +	
	scale_fill_viridis( option = "inferno", direction = +1, name = "Cases", limits= c(0,NA), trans= "log1p", breaks=10^seq(0,5), labels = label_number(accuracy = 1,big.mark = ','),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))

```
### Heat map: Deaths per Week

```{r,fig.width=13}
####################################################################
# Graphical Exploration New Deaths per State: Heat map
####################################################################

USStates.Covid19.all %>%  
	filter(Metric == "Deaths", Metric2 == 'delta7') %>%
	left_join(start, by="STNAME") %>% 
	group_by(STNAME) %>% 
	ggplot(aes(x=Date, y=reorder(STNAME, as.integer(StartDate)))) +
  geom_tile(aes(fill=val)) + 
	#geom_tile(data=start, aes(x=StartDate), fill='red',alpha=0.5) + 	
	scale_x_date(limits = c(date("2020-02-29"),NA)) +
	scale_y_discrete(position = "right")	+	
	labs(title="US State New Deaths per Week", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="") +
	theme_bw() +
	theme(legend.position = "right") +	
	scale_fill_viridis( option = "inferno", direction = +1, name = "Cases", limits= c(0,NA), trans= "log1p", breaks=10^seq(0,5), labels = label_number(accuracy = 1,big.mark = ','),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))

```

###  New Deaths per Day, normalized to peak, all states

```{r,fig.width=18, fig.height=13}
USStates.Covid19.all %>%  
	filter(Metric == "Deaths", Metric2 == 'delta', val >= 0) %>%
	group_by(STNAME) %>%
	mutate(rval=val/max(val)) %>%
  {	ggplot(data=., aes(x=Date, y=rval)) +
    geom_point(shape=1, size=2) + 
	  geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
    geom_label_repel(data=filter(., Date==max(Date) | val==max(val)), aes(label = val), nudge_x=2) +
	  scale_x_date(limits=c(date("2020-3-1"),NA)) +
	  #scale_y_log10(limits=c(10,NA), breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) +
	  labs(title="New Deaths per day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	  theme_bw() +
  	facet_wrap(vars(STNAME), ncol=7)
	}
```
todo
- sort per total number of deaths
- states with 2 weeks of lower than 10/day new encounters
- per capita
- red states vs blue states


## Per County

###  Confirmed Cases per top 25 County in US

```{r,fig.width=13}
####################################################################
# Graphical Exploration Confirmed Cases per top 25 County in US
####################################################################
topn <- function(df,n=25) group_by(df, UID) %>% summarise(val = max(val)) %>% top_n(n, wt=val) %>% pull(UID)
	
USCounties.Covid19.all %>% 
	filter(Metric == "Confirmed", Metric2 == 'n') %>% 
  filter(., UID %in% topn(.), val > 9) %>%
	{
	ggplot(data=.,aes(x=Date, y=val, group=FIPS, colour=USPS)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(CTYNAME,USPS,ks(val,0.1),sep=",")), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed Cases per Top US County", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	theme_bw() + theme(legend.position = "none")
	}
```


### Confirmed Cases in Massachussets Counties

```{r,fig.width=13}
####################################################################
# Graphical Exploration Confirmed Cases in MAss
####################################################################
USCounties.Covid19.all %>% 
	filter(Metric == "Confirmed", Metric2 == 'n') %>% 
  filter(USPS == "MA", val>9) %>%
	{
	ggplot(data=.,aes(x=Date, y=val, colour=CTYNAME)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(CTYNAME,ks(val,0.01),sep=",")), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed Cases in MA", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	theme_bw() 
	}
```

### Confirmed Cases in Counties with close proximity to Newburyport, MA

```{r,fig.width=13}
####################################################################
# Graphical Exploration Confirmed Cases in Counties with close proximity to Newburyport, MA
####################################################################
# https://www.movable-type.co.uk/scripts/latlong.html

NBPT <- c(Lat=42.8126,Long=-70.8773)

# top 10 closest counties near NBPT
USCounties %>% 
	mutate(Dist= Distance(Lat, Long, NBPT['Lat'], NBPT['Long'])) %>%
	top_n(10, wt=-Dist) %>% 
	pull(FIPS) -> nearNBPT

USCounties.Covid19.all %>% 
	filter(Metric == "Confirmed", Metric2 == 'n') %>% 
  filter(FIPS %in% nearNBPT, val>9) %>%
	{
	ggplot(data=.,aes(x=Date, y=val, colour=CTYNAME)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(CTYNAME, USPS, ks(val,0.01),sep=",")), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed Cases near NBPT", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	theme_bw() + theme(legend.position = "none")
	}
```

### New Confirmed Cases in US Counties near Newburyport, MA

```{r,fig.width=13}
####################################################################
# Graphical Exploration New Confirmed Cases in Counties with close proximity to Newburyport, MA, linear scale
####################################################################

USCounties.Covid19.all %>% 
	filter(Metric == "Confirmed", Metric2 == 'delta') %>% 
  filter(FIPS %in% nearNBPT, val>0) %>%
	group_by(UID) %>%
	{
	ggplot(data=.,aes(x=Date, y=val, colour=CTYNAME)) +
  geom_point(shape=1, size=3) + #geom_line() + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.20, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date) | val==max(val)), aes(label = paste(CTYNAME, USPS, val,sep=",")), nudge_x=2) +
	scale_x_date() +
	labs(title="New Confirmed Cases per Day near NBPT", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases/Day") +
	theme_bw() + theme(legend.position = "none")
	  }
```


#### Same but log scale


```{r,fig.width=13}
####################################################################
# Graphical Exploration New Confirmed Cases in Counties with close proximity to Newburyport, MA
####################################################################

USCounties.Covid19.all %>% 
	filter(Metric == "Confirmed", Metric2 == 'delta') %>% 
  filter(FIPS %in% nearNBPT, val>0) %>%
	group_by(UID) %>%
	{
	ggplot(data=.,aes(x=Date, y=val, colour=CTYNAME)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date) | val==max(val)), aes(label = paste(CTYNAME, USPS, val,sep=",")), nudge_x=2) +
	scale_x_date() +
	  scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                  labels = trans_format("log10", math_format(10^.x))) +
	  labs(title="New Confirmed Cases per Day near NBPT", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases/Day") +
	  theme_bw() + theme(legend.position = "none")
	  }
```


###  Daily Growth of Confirmed Cases per County, top25

```{r,fig.width=13}
####################################################################
# Graphical Exploration Daily Growth of Confirmed Cases per County
####################################################################

USCounties.Covid19.all %>% 
	filter(Metric == "Confirmed", Metric2 == 'delta') %>% 
  filter(., UID %in% topn(.,25), val > 9) %>%
	group_by(Province_State) %>%
	{
	ggplot(data=.,aes(x=Date, y=val, group=FIPS, colour=USPS)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date) | val==max(val)), aes(label = paste(CTYNAME,USPS,val,sep=",")), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="New Confirmed Cases per Top US County", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	theme_bw() + theme(legend.position = "none")
	}		
```

- New York -> Chicago -> LA  

todo
- time heatmap of top50 counties

# USA County Maps

- confirmed delta7: increase of confirmed cases in the last week 
- confirmed n: total confirmed cases
- deaths delta7: increase of deaths in the last week 
- deaths n: total deaths
- per capita:  per 100k inhabitants 

```{r,fig.width=18, fig.height=20}
####################################################################
# Graphical Exploration US Counties hatmaps on geomaps
####################################################################
# see https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/'
# see https://ggplot2.tidyverse.org/reference/coord_map.html
# see https://rpubs.com/omicsdata/faceted_heatmap

#todo fix color scale breaks
drawLabels <- function(L) labs(x = NULL, y = NULL, title = paste(L), subtitle = paste("Date =", date()), caption = "Geometries: ggplot2 maps; Covid-19 Data: JHU CSSE")

# 	pivot_longer(cols= c('val','valPerCap'), names_to='Metric3', values_to='val')  %>% 

PlotCountyMap <- function (m1="Confirmed", m2='n', pc=FALSE) {
	filter(USCounties.Covid19 , Metric == m1, Metric2 == m2 ) %>% 
	mutate(val = pc * (10^5 * val / POPESTIMATE2019) + (1-pc) *val) %>% 
	left_join(map.county, ., by="FIPS") %>% 
	ggplot(aes(x = long, y = lat)) +
  geom_polygon(aes(group = group, fill=val)) +
  geom_path(data=map.state, aes(x = long, y = lat, group = group), colour = "white", size=.2) +
	drawLabels(paste(m1, m2, ", per Capita =", pc)) +	
  theme_map() + 
	coord_map () +
	theme(legend.position = "right") +
	scale_fill_viridis( option = "inferno", direction = +1, name = "", limits= c(0,NA), breaks=10^seq(0,5),
											trans= "pseudo_log", labels = label_number(accuracy = 1, big.mark = ','),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5))
}	

# generate county plots
data.frame(pc=c(FALSE,TRUE), m1=c("Confirmed",'Deaths'), m2=c('n','delta7')) %>% expand(m1,m2, pc)  %>% 
	{ mapply(PlotCountyMap, m1=.$m1, m2=.$m2, pc=.$pc, SIMPLIFY = FALSE) } %>%
  grid.arrange( grobs = ., nrow=4, heights=rep(4,4))
```   

# Animated heat maps 

confirmed cases and new cases over time per US county

```{r,fig.width=13}
####################################################################
# Graphical Exploration Confirmed Cases in Counties with close proximity to Newburyport, MA
####################################################################

# outputs a gif 
AnimateCountyMap <- function (giffile, m1="Confirmed", m2='n', pc=FALSE) {
	filter(USCounties.Covid19.all , Metric == m1, Metric2 == m2 ) %>% 
	mutate(val = pc * (10^5 * val / POPESTIMATE2019) + (1-pc) *val) %>% 
	left_join(map.county, ., by="FIPS") %>% 
	ggplot(aes(x = long, y = lat)) +
  geom_polygon(aes(group = group, fill=val)) +
  geom_path(data=map.state, aes(x = long, y = lat, group = group), colour = "white", size=.2) +
	drawLabels(paste(m1, m2, ", per Capita =", pc)) +
	labs(title = paste("USA Covid-19", m1), caption = "Geometries: ggplot2 maps; Covid-19 Data: JHU CSSE") +
  theme_map() + 
	coord_map () +
	theme(legend.position = "right") +
	scale_fill_viridis( option = "inferno", direction = +1, name = "", limits= c(0,NA), breaks=10^seq(0,5),
											trans= "pseudo_log", labels = label_number(accuracy = 1, big.mark = ','),
                      guide = guide_colorbar(direction = "vertical", barheight = unit(50, units = "mm"), barwidth = unit(3, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.vjust = 0.5, label.vjust = 0.5)) +
	transition_time(Date, range=c(date("2020-2-15"), max(USStates.Covid19.all$Date))) +
	ease_aes('linear') +	
	labs(subtitle = "Date: {frame_time}")	-> p 
	animate(p, width = 1920/2, height = 1080/2, fps=10, duration=10, end_pause=5) %>% 
	anim_save(giffile, animation = .)
}	

if(wday(today(), label=TRUE) == "Sat") { # this takes hours to compute, only do this once a week on Saturday
	# generate county animations
  data.frame(pc=c(FALSE,TRUE), m1=c("Confirmed",'Deaths'), m2=c('n','delta7')) %>% 
		expand(m1,m2, pc)  %>% 
	  mutate(gif = paste0(paste("USMap",m1, m2,pc,sep="_"),".gif")) %>%	
		{ mapply(AnimateCountyMap, .$gif, m1=.$m1, m2=.$m2, pc=.$pc, SIMPLIFY = FALSE) }
}	
```


### USA Animated county maps

#### Total Confirmed Cases

BUG include_graphics only works in Rstudio, rndred dcs do not include the gif files in html 

```{r, fig.width=21}
knitr::include_graphics(file.path(".","USMap_Confirmed_n_FALSE.gif"))
```
!![Total Confirmed Cases per capita](USMap_Confirmed_n_FALSE.gif)

#### Total Confirmed Cases per Capita

```{r, fig.width=21}
knitr::include_graphics("USMap_Confirmed_n_TRUE.gif")
```
!![Total Confirmed Cases per capita](USMap_Confirmed_n_TRUE.gif)

#### New Confirmed Cases per week

```{r, fig.width=21}
knitr::include_graphics("USMap_Confirmed_delta7_FALSE.gif")
```
!![Weekly Cases](USMap_Confirmed_delta7_FALSE.gif)

#### New Confirmed Cases per week per Capita

```{r, fig.width=21}
knitr::include_graphics("USMap_Confirmed_delta7_TRUE.gif")
```
!![Weekly Cases per Capita(100k)](USMap_Confirmed_delta7_TRUE.gif)

#### Total Deaths 
```{r, fig.width=21}
knitr::include_graphics("USMap_Deaths_n_FALSE.gif")
```
!![Total Deaths](USMap_Deaths_n_FALSE.gif)

#### Total Deaths per Capita
```{r, fig.width=21}
knitr::include_graphics("USMap_Deaths_n_TRUE.gif")
```
!![Total Deaths per Capita(100k)](USMap_Deaths_n_TRUE.gif)

#### Total Deaths per week
```{r, fig.width=21}
knitr::include_graphics("USMap_Deaths_delta7_FALSE.gif")
```
!![Total Weekly Deaths](USMap_Deaths_delta7_FALSE.gif)

#### Total Deaths per week per Capita
```{r, fig.width=21}
knitr::include_graphics("USMap_Deaths_delta7_TRUE.gif")
```
!![Total Weekly Deaths per Capita(100k)](USMap_Deaths_delta7_TRUE.gif)

```{r, warning=FALSE, fig.width=21, message=FALSE}
####################################################################
# Animation
####################################################################
if(wday(today(),label=TRUE) == "Sat") { # takes hours, only do this once a week and save
USStates.Covid19.all %>%
  filter(Metric %in% c("Confirmed","Deaths"), Metric2 == "n") %>% 
	pivot_wider(names_from=c("Metric"), values_from = "val") %>% 
	ggplot(aes(x = Confirmed, y = Deaths, colour = STNAME)) +
	geom_point(aes( size = POPESTIMATE2019)) +
	#geom_label_repel(aes(label = USPS)) +
	scale_x_log10(limits=c(100,NA), breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) +
	scale_y_log10(limits=c(10,NA), breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) +
	#theme(legend.position = "none") +
	transition_time(Date, range=c(date("2020-03-01"),max(USStates.Covid19.all$Date))) +
  ease_aes('linear') +
	labs(subtitle = "Date: {frame_time}")	-> p  
	animate(p, width = 1920/2, height = 1080/2, fps=10, duration=20, end_pause=10, rewind=TRUE)  %>%
	anim_save("USAnimation.gif", animation = .)
}	
```



```{r, fig.width=21}
knitr::include_graphics("USAnimation.gif")
```
!![Cases and deaths over time animation](USAnimation.gif)

TODO: 

- CFR evolution 

- testing data from https://covidtracking.com/data

- plot highest cases as in https://covid19.who.int/

- load 2016 election data: blue, red states, 2016 presidential elecions, Governors

- add geo state and county areas, population density

- investigate correlation with state and county popuulation sensity

- Covid and politics load sstate and county 2016 election results: red, vs blue and margin

- investigate correlation with state and county election results

- investigatte if politics explains something more than population density

- add area and population densities

## References

* Johns Hopkins Covid-19 data https://github.com/CSSEGISandData/COVID-19

* World Population review, US States https://worldpopulationreview.com/static/states/abbr-name.csv

* US Census county population data  https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/totals/
