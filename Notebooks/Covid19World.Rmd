---
title: "Covid-19 Global Analysis"
output: html_notebook
---

# Introduction

This is an analysis of country level Covid-19 pandemic data as available from Johns Hopkins University in combination with United Nations population data. To hide code, toggle the 'Code' button on the top right of this page.



```{r, message=FALSE, warning=FALSE}
##################################
# packages and working directory
##################################

library(tidyverse)
library(lubridate)
library(scales)
library(httr)
library(RCurl)
library(kableExtra)
library(ggrepel)
library(gridExtra)
library(viridis)
library(gganimate)
library(gifski)
library(transformr)
library(tweenr)

options('gganimate.renderer' = gifski_renderer())
options(gganimate.dev_args = list(width = 1920, height = 1080))

print.gif_image <- function(x, ...) knitr::include_graphics(x, ...) # Bug fix in gganimate

setwd(tempdir())

ks <- function (x, acc=1) number_format(accuracy = acc, scale = 1/1000, suffix = "k", big.mark = ",")(x)
```


# Data Loading

The data for this analysis is from

- Johns Hopkins University Covid-19 data https://github.com/CSSEGISandData/COVID-19

- United Nation World Population Prospects 2019 https://population.un.org/wpp/Download/Standard/CSV/

- UN standard country or areaz codes for statistical use (M49 ) https://unstats.un.org/unsd/methodology/m49/overview/

```{r, message=FALSE}
####################################################################
# DATA LOADING from JHS on github: Global time series data
####################################################################
datapath <- "CSSEGISandData/COVID-19"

# get a file list
req <- GET(paste0("https://api.github.com/repos/", datapath,"/git/trees/master?recursive=1"))
stop_for_status(req)

content(req)$tree %>%
  lapply("[", "path") %>%
	unlist(use.names = F) %>%
  grep("csse_covid_19_data/csse_covid_19_time_series/", ., value = TRUE, fixed = TRUE) %>%
  grep(".csv", ., value = TRUE, fixed = TRUE) %>%
  grep("global", ., value = TRUE, fixed = TRUE) %>%
  #read the csv files
	lapply(function(x) { 
		read_csv(file.path("https://raw.githubusercontent.com", datapath, 'master', x)) %>%
		mutate(Metric=str_to_title(str_sub(x,66,-12))) %>%
		gather(-`Metric`, -`Province/State`, -`Country/Region`, -`Lat`, -`Long`, key='Date', value='n')
	})	%>%
	do.call(bind_rows, .) %>%
	pivot_wider(names_from='Metric', values_from='n', values_fill=list(n = 0)) %>%
	mutate(Active = Confirmed - Deaths - Recovered) %>%
	pivot_longer(cols=c("Confirmed","Deaths","Recovered","Active"), names_to='Metric', values_to='n') %>%
	mutate_each(funs(mdy), Date) %>% 
	mutate_each(funs(as.factor), Metric, `Province/State`, `Country/Region`) -> df
```


```{r, message=FALSE}
##################################
# Population data from United Nations
##################################
# EU countries: https://www.schengenvisainfo.com/eu-countries/
EU <- c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czechia", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden")

population_path <- file.path("~","DataScience","Covid19","data","population.csv")
if (!file.exists(population_path)) {
	wpp <- "https://population.un.org/wpp/Download/Files/1_Indicators%20(Standard)/CSV_FILES/WPP2019_TotalPopulationBySex.csv"
  read_csv(wpp) %>% 
	filter(Time==2020, Variant=='Medium', LocID < 900)%>% 
	select(-VarID,-Variant,-MidPeriod,-Time) %>% 
	mutate_at(c("PopMale","PopFemale","PopTotal","PopDensity"), function(x) as.integer(x*1000)) %>%
  mutate(inEU = Location %in% EU) %>%  	
	write_csv(population_path)
} 
read_csv(population_path) -> population
```



Data is aggregated per country, eg provinces are added to a total per country, and cases and deaths per capita are derived

```{r, message=FALSE, warning=FALSE}
####################################################################
# Aggregate per Country
####################################################################

df %>% 
	group_by(Date,`Country/Region`, Metric) %>% 
	summarise(n=sum(n)) %>% 
	ungroup -> df1

####################################################################
# Merge JHS Covid19 data and United Nations population data
####################################################################
library(reclin)

#1) create a linktable of JHS countries to United Nations LocID

group_by(df1, `Country/Region`) %>% summarise() %>% transmute(Location=as.character(`Country/Region`)) %>% arrange(Location) %>% mutate(JHUID=row_number()) -> AllJHUCountries 
select(population, LocID, Location) %>% mutate(Location = if_else(Location == 'Republic of Korea',"Korea, South", Location)) -> AllUNCountries 

pair_blocking(AllJHUCountries, AllUNCountries, large = FALSE) %>%
  compare_pairs(by = "Location", default_comparator = jaro_winkler(0.9), overwrite = TRUE) %>%
	score_problink(., model = problink_em(.), var = "weight") %>%
  select_n_to_m("weight", var = "ntom", threshold = 0) %>% 
  link() %>%
	filter(!is.na(Location.x)) ->  LinkTable 

#2) add UN information to JHU covid data 
left_join(df1, select(LinkTable, Location.x, JHUID, LocID), by=c("Country/Region"="Location.x")) %>%
	left_join(population, by="LocID") %>%
	mutate(Cap = 100000 * n /PopTotal) -> df2

```

The top 25 and top 50 counties are determined based on present confirmed cases

```{r}
####################################################################
# Countries of interest: top 25 and 50 countries of confirmed Covid19 cases
####################################################################

df2 %>% filter(Metric == 'Confirmed') %>% group_by(`Country/Region`) %>% summarise(n=max(n)) -> Countries 
Countries %>%	top_n(25, wt=n) %>% pull(`Country/Region`) -> top25
Countries %>%	top_n(50, wt=n) %>% pull(`Country/Region`) -> top50
df2 %>% filter(`Country/Region` %in% top25) -> df25
df2 %>% filter(`Country/Region` %in% top50) -> df50

df2 %>% filter(inEU | `Country/Region` == 'US' ) %>%
	mutate(Region = if_else(inEU,"EU","US")) -> dfUSEU
```


The day of outbreak is determined as the day when a country reaches 100 confirmed cases.

```{r}
##############################################
# Normalization to day of outbreak
##############################################
dealwithChina <- function(Date, Country) if_else(Country=='China', Date-7, Date)

# day of outbreak
df2 %>% filter(Metric== 'Confirmed') %>% 
	group_by(`Country/Region`) %>% 
	mutate(d=abs(n-100)) %>% 
	arrange(d) %>% 
	summarise_all(first) %>% 
	select(`Country/Region`, StartDate=Date) %>% 
	mutate(StartDate= dealwithChina(StartDate,`Country/Region`) ) -> start


# this is quite course, especially China, smoothe, extrapolate and find date closest to 100
library(rootSolve)
find_outbreak <- function(Date,n, tresh=100) {
	data.frame(Date=Date, n=n) %>%
	mutate(Day = as.numeric(Date - min(Date))) %>% 
	loess(n ~ Day, data=., span=0.4, control = loess.control(surface = "direct")) %>%
	predict(newdata=data.frame(Day=-0:100)) %>% 
	data.frame(x=as.numeric(names(.)), y= . - tresh) %>% 
  {uniroot.all(f=approxfun(.$x, .$y), interval=range(.$x))} %>%
	{min(Date) + last(.)} 
}

#test: does not work well
#df2 %>% filter(Metric== 'Confirmed', n > 50, `Country/Region` =="China") %>% {find_outbreak(.$Date,.$n)}

df50 %>% filter(Metric== 'Confirmed', n > 50) %>% 
	group_by(`Country/Region`) %>% 
	summarise(StartDate = find_outbreak(Date,n)) -> start2
```


# Graphical Exploration 

## Confirmed Cases for top 25 countries

Note 

- Confirmed cases are highly depending on testing and should not be mistaken with the true number of infected people. Confirmed cases depends on testing, and as Covid-19 testing is problemetic in most countries, confirmed cases is not a good estimate of total infected people.  

- Log scales on y axis may give wrong impression of differences between countries and exponentaial growth after outbreak.


```{r,fig.width=13}
####################################################################
# Graphical Exploration Confirmed Cases
####################################################################
df25 %>% filter(Metric== 'Confirmed', n > 50) %>% 
	{
	ggplot(.,aes(x=Date, y=n, colour=`Country/Region`)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`,ks(n),sep=',')), nudge_x=0.7) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed Cases", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	theme_bw() + theme(legend.position = "none")
	}		
```

*Observations*

- China reports cases as of late January, and flattens the curve around mid February

- Iran an Italy outbreak is mid February, Italy surpasses China on March 24

- USA outbreak is March 1st, cases increase to 10k in two weeks, 100k in 3 weeks. USA has most cases as of March 24 and continuues to increase to 1 million late April. 

- Spain outbreak is beginning of March and reaches 100k cases end of March, curve flattens more than USA (started at same moment)

- West Europe: UK, France, Germany, Belgium and Netherlands all start the first week of March

- Russia and Brazil outbreaks are a week later and fail to flatten their curve

- Mid of March is outbreak  South America (Mexico, Peru, Chile, Ecuador) and Asia Middle east and India/Pakistan


```{r,fig.width=13}
####################################################################
# Graphical Exploration Confirmed Cases per Day US vs EU
####################################################################
dfUSEU %>% filter(Metric== 'Confirmed') %>% 
  group_by(Date, Region) %>%
	summarise(n=sum(n)) %>%
	group_by(Region) %>%
	arrange(n) %>%
	mutate(NewCases = n-lag(n, default=0)) %>%
	{
	ggplot(.,aes(x=Date, y=NewCases, colour=Region)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.30, se=FALSE) +
	#geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`inEU`,ks(n),sep=',')), nudge_x=0.7) +
	scale_x_date() +
	labs(title="New Cases per Day US vs EU", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="New Cases") +
	theme_bw() 
	}		
```

## Confirmed Cases for top 25 countries

 Note Log scales on y axis
 

```{r,fig.width=13}
####################################################################
# Graphical Exploration Confirmed Cases
####################################################################
df25 %>% filter(Metric == 'Confirmed', n > 50) %>% 
	{
	ggplot(.,aes(x=Date, y=n)) +
  geom_point(shape=1, size=2) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(ks(n),sep=',')), nudge_x=0.7) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed Cases", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases") +
	theme_bw() +
	facet_wrap(vars(`Country/Region`))
	}		
```

## Active Cases for top 25 countries

```{r,fig.width=13}
####################################################################
# Graphical Exploration Active Cases
####################################################################
df25 %>% filter(Metric== 'Active', n > 50) %>%
	{
	ggplot(.,aes(x=Date, y=n, colour=`Country/Region`)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`,ks(n,0.1),sep=',')), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Active Cases", subtitle = paste(paste("Covid19 pandemic","-",date()),"-",date()), x="Time(2020)", y="Cases") +
	theme_bw() + theme(legend.position = "none")
	}	
```

```{r,fig.width=13}
####################################################################
# Graphical Exploration Daily Growth of Confirmed Cases
####################################################################

df25 %>% filter(Metric == 'Confirmed') %>% 
	group_by(`Country/Region`) %>%
	arrange(n) %>%
	mutate(NewCases = n-lag(n, default=0)) %>%
	filter(NewCases > 50) %>%
	{
	ggplot(., aes(x=Date, y=NewCases)) +
  geom_point(shape=1, size=2) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.70, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date) | NewCases==max(NewCases) ), aes(label = paste(ks(NewCases,0.1), sep=',')), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed New Cases per Day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases/Day") +
	theme_bw() +
	facet_wrap(vars(`Country/Region`))
	}
```

*Observations*

- China reports cases as of late January, has a maximum of 15k cases/day first week of February but reduces new cases drastically to 1k/day end February and further to 100 cases/day in March. April and May

- Countries that have significantly reduced new cases after a maximum are Belgium (92%), Canada(71%), France, Germany, Italy, Netherlands, Spain, Turkey, UK

- Countries with reduced new cases but still very high Iran, US, Sweden, Russia

- counties with increasing number of cases per day Brazil, Bangladesh, india, Pakistan Peru, Quator, Mexico, Saudia Arabia 

```{r,fig.width=13}
####################################################################
# Table
####################################################################

df25 %>% filter(Metric == 'Confirmed') %>% 
	group_by(`Country/Region`) %>%
	arrange(Date) %>%
	mutate(NewCases = n-lag(n, 7, default=0)) %>%
	summarize(Peak=Date[which.max(NewCases)]-3, Max=max(NewCases), Last=last(NewCases), Inc=Last / Max-1) %>%
	mutate(Decrease=cell_spec(percent(-Inc,accuracy=0.1),'html', color='white', background= ifelse(Inc < -0.5,"green", ifelse(Inc < -0.1, "black", "red")))) %>% 
	arrange(desc(Last)) %>% 
	mutate_at(vars(Max,Last), funs(ks(.,acc=0.1))) %>% 
	select(-Inc) %>%
	kable(format = "html", escape = F, align = "lcccc") %>% 
	kable_styling(fixed_thead = T, bootstrap_options = c("striped", "hover","condensed")) %>%
	column_spec(1, bold = T, border_right = T) %>%
	add_header_above(c(as.character(date()), "New Cases per week" = 4))
```

```{r,fig.width=13}
####################################################################
# Table: confirmed cases per capita
####################################################################

df50 %>% filter(Metric == 'Confirmed') %>% 
	group_by(`Country/Region`) %>%
	arrange(Date) %>%
	mutate(NewCases = Cap-lag(Cap, 7, default=0)) %>%
	summarize(Peak=Date[which.max(NewCases)]-3, Max=max(NewCases), Last=last(NewCases), Inc=Last / Max-1) %>%
	mutate(Decrease=cell_spec(percent(-Inc,accuracy=0.1),'html', color='white', background= ifelse(Inc < -0.5,"green", ifelse(Inc < -0.1, "black", "red")))) %>% 
	arrange(desc(Last)) %>% 
	mutate_at(vars(Max,Last), funs(round(.,1))) %>% 
	select(-Inc) %>%
	kable(format = "html", escape = F, align = "lcccc") %>% 
	kable_styling(fixed_thead = T, bootstrap_options = c("striped", "hover","condensed")) %>%
	column_spec(1, bold = T, border_right = T) %>%
	add_header_above(c(as.character(date()), "New Cases per Capita (100k) per week" = 4))
```


```{r,fig.width=13}
####################################################################
# Graphical Exploration Daily Growth of Confirmed Cases
####################################################################

df25 %>% filter(Metric == 'Confirmed') %>% 
	group_by(`Country/Region`) %>%
	arrange(n) %>%
	mutate(NewCases = n-lag(n, default=0)) %>%
	filter(NewCases > 50) %>%
	{
	ggplot(., aes(x=Date, y=NewCases,color=`Country/Region`)) +
  geom_point(shape=1, size=2) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.70, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date) | NewCases==max(NewCases) ), aes(label = paste(`Country/Region`,ks(NewCases,0.01), sep=',')), nudge_x=2) +
	scale_x_date() + scale_y_continuous(limits = c(0,NA)) +
	labs(title="New Confirmed New Cases per Day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="New Cases/day") +
	theme_bw() + theme(legend.position = "none")
	}
```

# Heath map Daily New Confirmed Cases, top 50 countries

```{r,fig.width=13}
####################################################################
# Graphical Exploration Daily Growth of Confirmed Cases
####################################################################

df50 %>% 
	filter(Metric == 'Confirmed') %>% 
	group_by(`Country/Region`) %>%
	arrange(n) %>%
	mutate(NewCases = n-lag(n, default=0)) %>%
	left_join(start, by="Country/Region") %>%
	{
	ggplot(., aes(x=Date, y=reorder(`Country/Region`, as.integer(StartDate)))) +
  geom_tile(aes(fill=NewCases)) + 
	scale_x_date() +
	scale_y_discrete(position = "right")	+	
	labs(title="New Confirmed Cases per Day", subtitle = "Covid19 pandemic-Top 50 Countries", x="Time(2020)", y="") +
	theme_bw() +
	theme(legend.position = "bottom") +		
	scale_fill_viridis( option = "inferno", direction = +1, name = "New Cases/day", limits= c(0,NA), 
											trans= "log1p", breaks=10^seq(0,5), labels = label_number(accuracy = 1, big.mark = ','),
                      guide = guide_colorbar(direction = "horizontal", barheight = unit(2, units = "mm"), barwidth = unit(50, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.hjust = 0.5, label.hjust = 0.5))
	}
```
Note: log scale heat map
- yellowish white means over 10k new cases per day
- red orange is 1000 cases a day
- dark red is 100 cases a day
- dark purple 10 cases a day


*Observations*

- few countries have 2 weeks of very low new cases afte their peak: China, South Korea, Japan, Switzerland, Austria, Denmark, Israel, Serbia

## Relative Increase in New Confirmed Cases

```{r,fig.width=13}
####################################################################
# Graphical Exploration Relative Daily Growth of Confirmed Cases
####################################################################

df25 %>% filter(Metric == 'Confirmed') %>% 
	group_by(`Country/Region`) %>%
	arrange(n) %>%
	mutate(NewCases = n/lag(n)-1 ) %>%
	filter(Date > max(Date) - 14) %>%
{
	ggplot(., aes(x=Date, y=NewCases, colour=`Country/Region`)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'lm', se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`,percent(NewCases, accuracy=0.1),sep=',')), nudge_x=0.7) +
	scale_x_date() +
	#ylim(0,1) +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Relative Increase of New Confirmed Cases per Day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Relative New Cases/day") +
	theme_bw() + theme(legend.position = "none")
}
```

```{r,fig.width=13}
####################################################################
# Graphical Exploration Deaths
####################################################################
df25 %>% filter(Metric== 'Deaths', n > 1) %>%
	{
	ggplot(., aes(x=Date, y=n)) +
  geom_point(shape=1, size=2) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date) ), aes(label = paste(ks(n,0.01), sep=',')), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Deaths", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Deaths count") +
	theme_bw() +
	facet_wrap(vars(`Country/Region`))
}
```

```{r,fig.width=13}
####################################################################
# Graphical Exploration Daily Increase of Deaths
####################################################################

df25 %>% filter(Metric == 'Deaths') %>% 
	group_by(`Country/Region`) %>%
	arrange(n) %>%
	mutate(New = n-lag(n, default=0)) %>%	
	filter(New > 1) %>%
	{
	ggplot(., aes(x=Date, y=New)) +
  geom_point(shape=1, size=2) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.50, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date) | New==max(New)), aes(label = paste(round(New), sep=',')), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="New Deaths per Day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Deaths/Day") +
	theme_bw() +
	facet_wrap(vars(`Country/Region`))
	}	
```

```{r,fig.width=13}
####################################################################
# Graphical Exploration Daily Growth of Deaths
####################################################################

df50 %>% 
	filter(Metric == 'Deaths') %>% 
	group_by(`Country/Region`) %>%
	arrange(n) %>%
	mutate(NewDeaths = n-lag(n, default=0)) %>%
	left_join(start, by="Country/Region") %>%
	{
	ggplot(., aes(x=Date, y=reorder(`Country/Region`, as.integer(StartDate)))) +
  geom_tile(aes(fill=NewDeaths)) + 
	scale_x_date() +
	scale_y_discrete(position = "right")	+	
	labs(title="Deaths per Day - Top 50 Countries", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="") +
	theme_bw() +
	theme(legend.position = "bottom") +		
	scale_fill_viridis( option = "inferno", direction = +1, name = "Deaths/Day", limits= c(0,NA), 
											trans= "log1p", breaks=10^seq(0,5), labels = label_number(accuracy = 1, big.mark = ','),
                      guide = guide_colorbar(direction = "horizontal", barheight = unit(2, units = "mm"), barwidth = unit(50, units = "mm"),
                                             draw.ulim = F, title.position = 'top', title.hjust = 0.5, label.hjust = 0.5))
	}
```

```{r,fig.width=13}
####################################################################
# Graphical Exploration Relative Daily Growth of Deaths
####################################################################

df25 %>% filter(Metric == 'Deaths') %>% 
	group_by(`Country/Region`) %>%
	arrange(n) %>%
	mutate(New = n/lag(n)-1 ) %>%	
	filter(Date > max(Date) - 14) %>%
	{
	ggplot(., aes(x=Date, y=New, colour=`Country/Region`)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'lm', se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`, percent(New,accuracy=0.1), sep=',')), nudge_x=0.7) +
	scale_x_date() +
	#ylim(0,1) +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Relative Increase of Deaths per Day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Relative Increase Deaths/day") +
	theme_bw() + theme(legend.position = "none")
	}
```


TODO

- CFR plot
- countries with increase-decrease during last two weeks
- testing statistics

```{r, fig.width=13}
##################################
# DATA VISUALIZATION Normalized per Capita
##################################
df25 %>% 
	filter(Metric== 'Confirmed', n > 50) %>%
	{
	ggplot(., aes(x=Date, y=Cap)) +
  geom_point(shape=1, size=2) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`, round(Cap,0), sep=',')), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed Cases per Capita (per 100k)", subtitle = paste("Covid19 pandemic","-",date()), x="Day after outbreak", y="Cases/Capita(100k)") +
	theme_bw() + theme(legend.position = "none") +
	facet_wrap(vars(`Country/Region`))
	}
```

```{r,fig.width=13}
####################################################################
# Graphical Exploration Daily Growth of Confirmed Cases
####################################################################

df25 %>% filter(Metric == 'Confirmed') %>% 
	group_by(`Country/Region`) %>%
	arrange(n) %>%
	mutate(NewCases = 10^5*(n-lag(n, default=0)) / PopTotal) %>%
	filter(NewCases > 0) %>%
	{
	ggplot(., aes(x=Date, y=NewCases)) +
  geom_point(shape=1, size=2) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.70, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date) | NewCases==max(NewCases) ), aes(label = round(NewCases,1)), nudge_x=2) +
	scale_x_date() +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed New Cases per Capita (100k) per Day", subtitle = paste("Covid19 pandemic","-",date()), x="Time(2020)", y="Cases/Day") +
	theme_bw() +
	facet_wrap(vars(`Country/Region`)) 
	}
```

```{r, fig.width=13}
##################################
# DATA INSPECTION - normalized from outbreak
##################################

start %>% filter(StartDate != min(StartDate)) %>% pull(StartDate) %>% min -> earlyDate
ceiling(as.numeric(today() - earlyDate)/5)*5 -> horizon  

df50 %>% left_join(start, by="Country/Region") %>% 
	mutate(Day= Date - StartDate) %>%
	filter(Metric== 'Confirmed', n > 50) %>%
  { ggplot(., aes(x=Day, y=n, colour=`Country/Region`)) +
  geom_point(shape=1, size=3) + 
	xlim(-5,horizon) +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`, ks(n), sep=',')), nudge_x=.3) +
	labs(title="Confirmed Cases relative to local outbreak", subtitle = paste("Covid19 pandemic","-",date()), x="Day after outbreak", y="Cases") +
	theme_bw() + theme(legend.position = "none")
  }	
```


```{r, fig.width=13}
##################################
# DATA INSPECTION - normalized from outbreak
##################################
df50 %>% left_join(start, by="Country/Region") %>% 
	mutate(Day= Date - StartDate) %>%
	filter(Metric== 'Active', n > 50) %>% 
	{ ggplot(data=., aes(x=Day, y=n, colour=`Country/Region`)) +
  geom_point(shape=1, size=3) + 
	xlim(-5,horizon) +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`, ks(n), sep=',')), nudge_x=.3) +
	labs(title="Active Cases relative to local outbreak", subtitle = paste("Covid19 pandemic","-",date()), x="Day after outbreak", y="Cases") +
	theme_bw() + theme(legend.position = "none")
}
```



```{r, fig.width=13}
##################################
# DATA VISUALIZATION Normalized per Capita
##################################
df50 %>% 
	left_join(start, by="Country/Region") %>% 
	mutate(Day= Date - StartDate) %>%
	filter(Metric== 'Confirmed', n > 50) %>%
	{
	ggplot(., aes(x=Day, y=Cap, colour=`Country/Region`)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', span=0.40, se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`, round(Cap,1), sep=',')), nudge_x=2) +
	xlim(-5,horizon) +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Confirmed Cases per Capita (per 100k)", subtitle = paste("Covid19 pandemic","-",date()), x="Day after outbreak", y="Cases/Capita(100k)") +
	theme_bw() + theme(legend.position = "none")
	}
```



```{r, fig.width=13}
##################################
# DATA VISUALIZATION Normalized per Capita
##################################
df50 %>% 
	left_join(start, by="Country/Region") %>% 
	mutate(Day= Date - StartDate) %>%
	filter(Metric== 'Deaths', n > 1, Day <= horizon) %>% 
	{
	ggplot(., aes(x=Day, y=Cap, colour=`Country/Region`)) +
  geom_point(shape=1, size=3) + 
	geom_smooth(formula ='y ~ x',method = 'loess', se=FALSE) +
	geom_label_repel(data=filter(., Date==max(Date)), aes(label = paste(`Country/Region`, round(Cap,1), sep=',')), nudge_x=2) +
	xlim(-5,horizon) +
	scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
                labels = trans_format("log10", math_format(10^.x))) +
	labs(title="Deaths per Capita (per 100k)", subtitle = paste("Covid19 pandemic","-",date()), x="Day after outbreak", y="Deaths/Capita(100k)") +
	theme_bw() + theme(legend.position = "none")
	}		
```

## Animations

### Confirmed cases and Deaths for top 50 countries

```{r, warning=FALSE, fig.width=21, message=FALSE}
####################################################################
# Animation
####################################################################
if(wday(today(),label=TRUE) == "Sun") { # takes 20 minutes, only do this once a week and save
df50 %>% 
	select(Date, Location, Metric, n, PopTotal) %>%
  filter(n > 0) %>% 
	pivot_wider(names_from = "Metric", values_from = "n") %>% 
	ggplot(aes(x = Confirmed, y = Deaths, colour = Location)) +
	  geom_point(aes(size = PopTotal)) +
	  #geom_label_repel(aes(label = Location)) +
	  scale_x_log10(limits=c(100,NA), breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) +
	  scale_y_log10(limits=c(1,NA), breaks = trans_breaks("log10", function(x) 10^x), labels = trans_format("log10", math_format(10^.x))) +
	  #theme(legend.position = "none") +
	  transition_time(Date, range=c(date("2020-1-15"),max(df50$Date))) +
		ease_aes('linear') +
		labs(subtitle = "Date: {frame_time}")	-> p  
	animate(p, width = 1920/2, height = 1080/2, fps=10, duration=20, end_pause=5, rewind=TRUE)  %>%
	anim_save("WorldAnimation.gif", animation = .)
}	
```

```{r, fig.width=21}
knitr::include_graphics("WorldAnimation.gif")
```
!![Cases and deaths over time animation](WorldAnimation.gif)


```{r}
df25 %>% 
	filter(Metric %in% c('Confirmed','Deaths')) %>% 
	select(Date, Metric, `Country/Region`,  n, PopTotal) %>% 
	spread(Metric,n) %>% 
	group_by(`Country/Region`) %>%
	summarise(DConfirmed = last(Confirmed)-nth(Confirmed,-2), DDeaths = last(Deaths)-nth(Deaths,-2), g=last(Deaths)/nth(Deaths,-28), Confirmed=last(Confirmed), Deaths = last(Deaths)) %>% 
	mutate(CFR = 100 * Deaths / Confirmed, DGrowth = DDeaths/Deaths, EstInfect = round(g*Deaths / 0.015), IFR = 100 * Deaths/EstInfect, UnderEst=round(EstInfect/Confirmed,1) ) %>%
	arrange(desc(EstInfect)) %>%
	select(-g) %>%
	kable() %>% kable_styling()
```

```{r}

df25 %>% 
	filter(Metric %in% c('Confirmed','Deaths')) %>% 
	select(`Country/Region`, Metric, n, Date) %>%
	spread(Metric,n) %>%
	group_by(`Country/Region`) %>%
	mutate(NewCases = Confirmed-lag(Confirmed), relNewCases = Confirmed/lag(Confirmed)-1, NewDeaths = Deaths-lag(Deaths), relNewDeaths = Deaths/lag(Deaths)-1) %>%
	filter(Date == max(Date))  %>%
	select(-Date) %>%
	arrange(desc(NewDeaths)) %>% 
	kable() %>% kable_styling()
```

# Predictions

## May 1st, 2020

- By end of May, US will have 1.5 million confirmed cases and 100k deaths

outcome: 1.79 million cases, and 104k deaths on May 31 2020

## June 1st, 2020

- By end of June, US will have minimum 2.3 million confirmed cases and 125k deaths

- New cases per day trend will reverse and start growing again before end of June (result of early reopenings and protests) 

- By end of June, Brazil will have 2 million confirmed cases and be very close to USA

outcome: on June 30


#References


* R0 estimation https://bmcmedinformdecismak.biomedcentral.com/articles/10.1186/1472-6947-12-147

* https://www.worldometers.info/coronavirus/coronavirus-incubation-period/

* https://www.worldometers.info/coronavirus/coronavirus-death-rate/
